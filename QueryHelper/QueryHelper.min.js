(function(){var d=document,wl=window.location,url=wl.href.replace(wl.search,""),qreg=/\/query\/?$/i,ac;function ajax(u,cb,data,x){try{x=new(this.XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");x.open(data?"POST":"GET",u,1);x.setRequestHeader("X-Requested-With","XMLHttpRequest");x.setRequestHeader("Content-type","application/x-www-form-urlencoded");x.onreadystatechange=function(){x.readyState>3&&cb&&cb(JSON.parse(x.responseText),x);};x.send(data);}catch(e){window.console&&console.log(e);}}function listenAll(n,s,evt,cb){[].forEach.call(n.querySelectorAll(s),function(el){el[evt]=cb;});}function build(fs){var div=d.createElement("div"),listF=d.createElement("select"),listR=d.createElement("select"),btns=d.createElement("div");div.setAttribute("style","position:fixed;top:10%;right:0;width:35%;padding:5px;background:#fff;overflow:auto;");div.innerHTML="<button style=\"float:right;\" onclick=\"this.parentNode.parentNode.removeChild(this.parentNode);\">Close</button><b>Query Builder</b><br />";d.body.appendChild(div);listF.setAttribute("size","10");listF.innerHTML=fs.map(function(field){return["<option value=\"",field.name,"\">",field.alias,"</option>"].join("");}).join("");div.appendChild(listF);listR.setAttribute("size","10");div.appendChild(listR);listF.onchange=function(){var val=listF.value;ajax(url+"?where=field+like+%27%25%27&returnGeometry=false&outFields=field&orderByFields=field&returnDistinctValues=true&f=json".replace(/field/g,val),function(res){listR.innerHTML=[].map.call(res.features,function(fr){var i=fr.attributes[val];return["<option value=\"",i,"\">",i,"</option>"].join("");});});};btns.innerHTML=[" = "," &lt;&gt; "," LIKE "," &gt; "," &gt;= "," AND "," &lt; "," &lt;= "," OR ","_","%","()","NOT "," IS ","*","&#39;&#39;"," IN ",", "].map(function(txt){return["<button class=\"sql\" type=\"button\" name=\"",txt,"\">",txt.replace(/\s+/g,""),"</button>"].join("");});div.appendChild(btns);return div;}function setActive(value){var oldVal=ac.value.substring(0),iC=oldVal.length;ac.focus();if(d.selection){var oSel=d.selection.createRange();oSel.moveStart("character",-ac.value.length);iC=oSel.text.length;}else if("selectionStart"in ac){iC=ac.selectionStart;}ac.value=oldVal.substring(0,iC)+value+oldVal.substring(iC);iC+=value.length-(["()",decodeURIComponent("%27%27")].indexOf(value)>-1);if(ac.createTextRange){var range=ac.createTextRange();range.move("character",iC);range.select();}else if("selectionStart"in ac){ac.setSelectionRange(iC,iC);}}function onLoad(r){var n=build(r.fields);listenAll(n,"select","onclick",function(evt){setActive(evt.currentTarget.value);});listenAll(n,"button.sql","onclick",function(evt){setActive(evt.currentTarget.name);});}listenAll(d,"input[type=text], textarea","onblur",function(){ac=this;});if(qreg.test(url)){ajax(url.replace(qreg,"")+"?f=json",onLoad);}else{if(!/(map|feature)server\/\d+\/?$/i.test(url)){alert("Go to the query page to use this tool.");}else{alert("Pick a valid layer");}}}());