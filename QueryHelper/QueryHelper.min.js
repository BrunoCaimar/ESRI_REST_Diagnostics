(function(){var f=document,k=window.location,b=k.href.replace(k.search,""),h=/\/query\/?$/i,e;function i(l,o,m,d){try{d=new (this.XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");d.open(m?"POST":"GET",l,1);d.setRequestHeader("X-Requested-With","XMLHttpRequest");d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){d.readyState>3&&o&&o(JSON.parse(d.responseText),d)};d.send(m)}catch(n){window.console&&console.log(n)}}function c(m,d,l,n){[].forEach.call(m.querySelectorAll(d),function(o){o[l]=n})}function j(l){var o=f.createElement("div"),m=f.createElement("select"),d=f.createElement("select"),n=f.createElement("div");o.setAttribute("style","position:fixed;top:10%;right:0;width:35%;padding:5px;background:#fff;overflow:auto;");o.innerHTML="<button style=\"float:right;\" onclick=\"this.parentNode.parentNode.removeChild(this.parentNode);\">Close</button><b>Query Builder</b><br />";f.body.appendChild(o);m.setAttribute("size","10");m.innerHTML=l.map(function(p){return["<option value=\"",p.name,"\">",p.alias,"</option>"].join("")}).join("");o.appendChild(m);d.setAttribute("size","10");o.appendChild(d);m.onchange=function(){var p=m.value;i(b+"?where=1%3D1&returnGeometry=false&outFields=field&orderByFields=field&returnDistinctValues=true&f=json".replace(/field/g,p),function(q){d.innerHTML=[].map.call(q.features,function(r){return["<option value=\"",r.attributes[p],"\">",r.attributes[p],"</option>"].join("")})})};n.innerHTML=[" = "," &lt;&gt; "," LIKE "," &gt; "," &gt;= "," AND "," &lt; "," &lt;= "," OR ","_","%","()","NOT "," IS ","*","&#39;&#39;"," IN ",", "].map(function(p){return["<button class=\"sql\" type=\"button\" name=\"",p,"\">",p.replace(/\s+/g,""),"</button>"].join("")});o.appendChild(n);return o}function a(n){var m=e.value.substring(0),o=m.length;e.focus();if(f.selection){var d=f.selection.createRange();d.moveStart("character",-e.value.length);o=d.text.length}else{if("selectionStart" in e){o=e.selectionStart}}e.value=m.substring(0,o)+n+m.substring(o);o+=n.length-(["()",decodeURIComponent("%27%27")].indexOf(n)>-1);if(e.createTextRange){var l=e.createTextRange();l.move("character",o);l.select()}else{if("selectionStart" in e){e.setSelectionRange(o,o)}}}function g(d){var l=j(d.fields);c(l,"select","onclick",function(m){a(m.currentTarget.value)});c(l,"button.sql","onclick",function(m){a(m.currentTarget.name)})}c(f,"input[type=text], textarea","onblur",function(){e=this});if(h.test(b)){i(b.replace(h,"")+"?f=json",g)}else{if(!/(map|feature)server\/\d+\/?$/i.test(b)){alert("Go to the query page to use this tool.")}else{alert("Pick a valid layer")}}}());
