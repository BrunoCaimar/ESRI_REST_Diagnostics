(function(){var d=document,form=d.createElement("form"),txt=d.createElement("input"),btn=d.createElement("button"),rL=d.createElement("ul"),locs,hits;function ajax(u,callback,data,x){try{x=new(this.XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");x.open(data?"POST":"GET",u,1);x.setRequestHeader("X-Requested-With","XMLHttpRequest");x.setRequestHeader("Content-type","application/x-www-form-urlencoded");x.onreadystatechange=function(){x.readyState>3&&callback&&callback(JSON.parse(x.responseText),x);};x.send(data);}catch(e){window.console&&console.log(e);}}function gFV(fs,dt){var rs=dt.hasOwnProperty(fs[0])?dt[fs[0]]:null;if(rs!=null&&fs.length>1){if(rs instanceof Array){return rs.map(function(item){return gFV(fs.slice(1),item);});}return gFV(fs.slice(1),rs);}return rs;}function pR(f,rs,url){var li=d.createElement("li"),link=d.createElement("a");link.setAttribute("href",url);link.innerHTML=[url.replace(/^\S*\/rest\/services\//i,""),"=> ",f,": ",rs].join("");li.appendChild(link);rL.appendChild(li);}function cAP(mT,f,rs,url){if(mT(rs)){hits++;pR(f,rs,url);}}function rSc(url,dt,mT){var fL=["name","description","displayField","fields.name","fields.alias","mapName","layers.name","documentInfo.Title","documentInfo.Comments","documentInfo.Subject","documentInfo.Category","documentInfo.Keywords","folders","services.name","services.type"];fL.forEach(function(f){var rs=gFV(f.split("."),dt);if(rs==null){return;}if(rs instanceof Array){rs.forEach(function(item){cAP(mT,f,item,url);});}else{cAP(mT,f,rs,url);}});}function sUs(url,dt){var ls=[],runners={"folders":function(fd){return[url,fd].join("/");},"services":function(sc){return[url,sc.name.replace(/\w+\//ig,""),sc.type].join("/");},"layers":function(layer){return[url,layer.id].join("/");},"tables":function(table){return[url,table.id].join("/");}},r;for(r in runners){if(dt[r]&&dt[r].length){ls=ls.concat(dt[r].map(runners[r]));}}return ls;}function queryMe(ls,mT){if(!ls.length){return;}var url=ls.shift();ajax(url+"?f=json",function(dt){locs++;rSc(url,dt,mT);ls=ls.concat(sUs(url,dt));if(ls.length){queryMe(ls,mT);}else{btn.removeAttribute("disabled");btn.innerHTML="Search";var li=d.createElement("li");rL.insertBefore(li,rL.firstChild);li.innerHTML=["<b>Places Searched:</b>",locs,"<br/><b>Results found</b>",hits].join(" ");}});}function oSt(){var sF,mT;if(txt.value){while(rL.childNodes.length){rL.removeChild(rL.childNodes[0]);}btn.innerHTML="Scanning";btn.setAttribute("disabled","disabled");if(/^\d*\.?\d+$/.test(txt.value)){sF=/\./.test(txt.value)?parseFloat(txt.value):parseInt(txt.value,10);mT=function(val){return val===sF;};}else{sF=new RegExp(txt.value,"i");mT=function(val){return sF.test(val);};}locs=0;hits=0;queryMe([location.href.replace(location.search,"")],mT);}else{alert("Please enter a value");}return false;}form.setAttribute("style","position:fixed;top:5px;right:5px;width:300px;height:80%;overflow:auto;z-index:100;background:#fff;font-size:0.9em;");txt.setAttribute("style","width:75%");form.appendChild(txt);btn.innerHTML="Search";btn.onclick=oSt;form.appendChild(btn);form.appendChild(rL);d.body.appendChild(form);}());