(function(){var d=document,form=d.createElement("form"),txt=d.createElement("input"),btn=d.createElement("button"),resultList=d.createElement("ul"),locs,hits;function ajax(u,callback,data,x){try{x=new(this.XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");x.open(data?"POST":"GET",u,1);x.setRequestHeader("X-Requested-With","XMLHttpRequest");x.setRequestHeader("Content-type","application/x-www-form-urlencoded");x.onreadystatechange=function(){x.readyState>3&&callback&&callback(JSON.parse(x.responseText),x);};x.send(data);}catch(e){window.console&&console.log(e);}}
function getFinalVal(fields,data){var result=data.hasOwnProperty(fields[0])?data[fields[0]]:null;if(result!=null&&fields.length>1){if(result instanceof Array){return result.map(function(item){return getFinalVal(fields.slice(1),item);});}
return getFinalVal(fields.slice(1),result);}
return result;}
function printResult(field,result,url){var li=d.createElement("li"),link=d.createElement("a");link.setAttribute("href",url);link.innerHTML=[url.replace(/^\S*\/rest\/services\//i,""),"=> ",field,": ",result].join("");li.appendChild(link);resultList.appendChild(li);}
function checkAndPrint(myTest,field,result,url){if(myTest(result)){hits++;printResult(field,result,url);}}
function responseSearch(url,data,myTest){var fieldList=["name","description","displayField","fields.name","fields.alias","mapName","layers.name","documentInfo.Title","documentInfo.Comments","documentInfo.Subject","documentInfo.Category","documentInfo.Keywords","folder","service.name"];fieldList.forEach(function(field){var result=getFinalVal(field.split("."),data);if(result==null){return;}
if(result instanceof Array){result.forEach(function(item){checkAndPrint(myTest,field,item,url);});}else{checkAndPrint(myTest,field,result,url);}});}
function subUrls(url,data){var list=[],runners={"folders":function(folder){return[url,folder].join("/");},"services":function(service){return[url,service.name.replace(/\w+\//ig,""),service.type].join("/");},"layers":function(layer){return[url,layer.id].join("/");},"tables":function(table){return[url,table.id].join("/");}},r;for(r in runners){if(data[r]&&data[r].length){list=list.concat(data[r].map(runners[r]));}}
return list;}
function queryMe(list,myTest){if(!list.length){return;}
var url=list.shift();ajax(url+"?f=json",function(data){locs++;responseSearch(url,data,myTest);list=list.concat(subUrls(url,data));if(list.length){queryMe(list,myTest);}else{btn.removeAttribute("disabled");btn.innerHTML="Search";var li=d.createElement("li");resultList.insertBefore(li,resultList.firstChild);li.innerHTML=["<b>Places Searched:</b>",locs,"<br/><b>Results found</b>",hits].join(" ");}});}
function onSubmit(){var searchFor,myTest;if(txt.value){while(resultList.childNodes.length){resultList.removeChild(resultList.childNodes[0]);}
btn.innerHTML="Scanning";btn.setAttribute("disabled","disabled");if(/^\d*\.?\d+$/.test(txt.value)){searchFor=/\./.test(txt.value)?parseFloat(txt.value):parseInt(txt.value,10);myTest=function(val){return val===searchFor;};}else{searchFor=new RegExp(txt.value,"i");myTest=function(val){return searchFor.test(val);};}
locs=0;hits=0;queryMe([window.location.href.replace(window.location.search,"")],myTest);}else{alert("Please enter a value");}
return false;}
form.setAttribute("style","position:fixed;top:5px;right:5px;width:300px;height:80%;overflow:auto;z-index:100;background:#fff;font-size:0.9em;");txt.setAttribute("style","width:75%");form.appendChild(txt);btn.innerHTML="Search";btn.onclick=onSubmit;form.appendChild(btn);form.appendChild(resultList);d.body.appendChild(form);}());