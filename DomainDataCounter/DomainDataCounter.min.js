(function(){var url=window.location.href,d=document;function ajax(u,callback,data,x){try{x=new(this.XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");x.open(data?"POST":"GET",u,1);x.setRequestHeader("X-Requested-With","XMLHttpRequest");x.setRequestHeader("Content-type","application/x-www-form-urlencoded");x.onreadystatechange=function(){x.readyState>3&&callback&&callback(x.responseText,x);};x.send(data);}catch(e){window.console&&console.log(e);}}function queryMe(f,ns,tr){if(!f.length){return;}if(!tr){var n=ns.shift();tr=d.createElement("ul");n.appendChild(tr);}if(f[0].length){var im=f[0].shift(),value=im.type==="esriFieldTypeString"?"'"+im.code+"'":im.code,params="/query?where=field+%3D+value&returnGeometry=false&returnCountOnly=true&f=json".replace("field",im.field).replace("value",value);ajax(url+params,function(rs){rs=JSON.parse(rs);var li=d.createElement("li");li.innerHTML=["<b>",im.name,": </b>",rs.count,(!rs.count?"<b style=\"color:#f00;\"> !!!</b>":"")].join("");tr.appendChild(li);if(f[0].length){queryMe(f,ns,tr);}else{f.shift();if(f.length){queryMe(f,ns);}}});}}function getFieldList(){var uls=d.getElementsByTagName("ul"),ls=[].map.call(uls,function(n){var h=n;while(h.previousSibling){h=h.previousSibling;if(h.tagName==="B")break;}return h.innerHTML;}),i;for(i=uls.length-1;i>-1;i--){if(ls[i]==="Fields: "){return[].map.call(uls[i].children,function(j){return j;});}}return null;}function onLoad(rs){var fn,fd,fs=[],i;rs=JSON.parse(rs);if(rs.fields){fn=getFieldList();for(i=rs.fields.length-1;i>-1;i--){fd=rs.fields[i];if(fd.domain){if(fd.domain.codedValues){fs.push(fd.domain.codedValues.map(function(im){im.field=fd.name;im.type=fd.type;return im;}));}else if(fd.domain.range){}}else{fn.splice(i,1);}}fs.reverse();queryMe(fs,fn,null);}}if(/\d+\/?$/.test(url)){ajax(url+"?f=json",onLoad);}else{if(!/(map|feature)server\/?$/i.test(url)){alert("Pick a map/feature service and layer");}else{alert("Pick a valid layer");}}}());